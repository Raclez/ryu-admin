FROM node:20-slim AS builder

# --max-old-space-size
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
ENV NODE_OPTIONS=--max-old-space-size=8192
ENV TZ=Asia/Shanghai

RUN corepack enable

WORKDIR /app

# copy package.json and pnpm-lock.yaml to workspace
COPY . /app

# å®‰è£…ä¾èµ–å¹¶åˆ›å»ºç¼ºå¤±çš„åŒ…
RUN --mount=type=cache,id=pnpm,target=/pnpm/store pnpm install --no-frozen-lockfile

# åˆ›å»ºç¼ºå¤±çš„tsconfigåŒ…
RUN mkdir -p packages/@vben/tsconfig
RUN echo '{\
  "name": "@vben/tsconfig",\
  "version": "1.0.0",\
  "main": "index.js",\
  "files": ["*.json"]\
}' > packages/@vben/tsconfig/package.json

# åˆ›å»ºåŸºç¡€çš„tsconfigæ–‡ä»¶
RUN echo '{\
  "$schema": "https://json.schemastore.org/tsconfig",\
  "display": "Default",\
  "compilerOptions": {\
    "target": "ESNext",\
    "module": "ESNext",\
    "moduleResolution": "Bundler",\
    "strict": true,\
    "esModuleInterop": true,\
    "skipLibCheck": true,\
    "forceConsistentCasingInFileNames": true\
  }\
}' > packages/@vben/tsconfig/base.json

RUN echo '{\
  "$schema": "https://json.schemastore.org/tsconfig",\
  "display": "Web Application",\
  "extends": "./base.json",\
  "compilerOptions": {\
    "lib": ["ESNext", "DOM", "DOM.Iterable"],\
    "types": ["vite/client"]\
  }\
}' > packages/@vben/tsconfig/web-app.json

RUN echo '{\
  "$schema": "https://json.schemastore.org/tsconfig",\
  "display": "Web",\
  "extends": "./base.json",\
  "compilerOptions": {\
    "lib": ["ESNext", "DOM", "DOM.Iterable"]\
  }\
}' > packages/@vben/tsconfig/web.json

RUN echo '{\
  "$schema": "https://json.schemastore.org/tsconfig",\
  "display": "Node",\
  "extends": "./base.json",\
  "compilerOptions": {\
    "module": "ESNext",\
    "moduleResolution": "Bundler"\
  }\
}' > packages/@vben/tsconfig/node.json

RUN echo '{\
  "$schema": "https://json.schemastore.org/tsconfig",\
  "display": "Library",\
  "extends": "./base.json",\
  "compilerOptions": {\
    "declaration": true,\
    "declarationMap": true\
  }\
}' > packages/@vben/tsconfig/library.json

# åˆ›å»ºç¼ºå¤±çš„vite-configåŒ…
RUN mkdir -p packages/@vben/vite-config/src
RUN echo '{\
  "name": "@vben/vite-config",\
  "version": "1.0.0",\
  "type": "module",\
  "main": "src/index.js"\
}' > packages/@vben/vite-config/package.json

RUN echo 'import { defineConfig as viteDefineConfig } from "vite";\n\
export function defineConfig(fn) {\
  return async () => {\
    const config = await fn();\
    return viteDefineConfig(config.vite);\
  };\
}\n\
export default defineConfig;' > packages/@vben/vite-config/src/index.js

# åˆ›å»ºç¼ºå¤±çš„typesåŒ…
RUN mkdir -p packages/@vben/types
RUN echo '{\
  "name": "@vben/types",\
  "version": "1.0.0",\
  "types": "global.d.ts"\
}' > packages/@vben/types/package.json

RUN echo '// å…¨å±€ç±»å‹å®šä¹‰\
declare global {\
  interface Window {\
    [key: string]: any;\
  }\
}' > packages/@vben/types/global.d.ts

# ç¡®ä¿@vben-core/shared/cacheç›®å½•å­˜åœ¨å¹¶åˆ›å»ºå¿…è¦çš„æ–‡ä»¶
RUN mkdir -p packages/@core/base/shared/src/cache
RUN echo '// ç¼“å­˜å®ç°\
import { createStorage } from "../utils/storage";\
\
// é»˜è®¤ç¼“å­˜æ—¶é—´
export const DEFAULT_CACHE_TIME = 60 * 60 * 24 * 7; // 7å¤©\
\
// åˆ›å»ºlocalStorageç¼“å­˜
export const createLocalStorage = (options = {}) => {\
  return createStorage({\
    storage: localStorage,\
    ...options,\
  });\
};\
\
// åˆ›å»ºsessionStorageç¼“å­˜
export const createSessionStorage = (options = {}) => {\
  return createStorage({\
    storage: sessionStorage,\
    ...options,\
  });\
};\
\
export const defaultCache = createLocalStorage();\
\
// å¯¼å‡ºå¸¸ç”¨çš„å­˜å‚¨æ“ä½œæ–¹æ³•
export class Cache {\
  private cache: ReturnType<typeof createStorage>;\
\
  constructor(storage = defaultCache) {\
    this.cache = storage;\
  }\
\
  get<T = any>(key: string, def: T | null = null): T {\
    return this.cache.get(key) || def;\
  }\
\
  set(key: string, value: any, expire = DEFAULT_CACHE_TIME) {\
    this.cache.set(key, value, expire);\
  }\
\
  remove(key: string) {\
    this.cache.remove(key);\
  }\
\
  clear() {\
    this.cache.clear();\
  }\
}' > packages/@core/base/shared/src/cache/index.ts

# ç¡®ä¿utilsç›®å½•ä¸‹æœ‰storage.tsæ–‡ä»¶
RUN mkdir -p packages/@core/base/shared/src/utils
RUN echo '// å­˜å‚¨å·¥å…·å‡½æ•°\
export interface StorageOption {\
  storage: Storage;\
  prefix?: string;\
}\
\
export interface Storage {\
  getItem(key: string): string | null;\
  setItem(key: string, value: string): void;\
  removeItem(key: string): void;\
  clear(): void;\
}\
\
export interface CreateStorageParams extends StorageOption {\
  timeout?: number;\
}\
\
export function createStorage({\
  storage = localStorage,\
  prefix = "",\
  timeout = 0,\
}: Partial<CreateStorageParams> = {}) {\
  function getKey(key: string) {\
    return `${prefix}${key}`.toUpperCase();\
  }\
\
  function set(key: string, value: any, expire = timeout) {\
    const stringData = JSON.stringify({\
      value,\
      expire: expire !== 0 ? new Date().getTime() + expire * 1000 : 0,\
    });\
    storage.setItem(getKey(key), stringData);\
  }\
\
  function get(key: string) {\
    const item = storage.getItem(getKey(key));\
    if (!item) return null;\
\
    try {\
      const data = JSON.parse(item);\
      const { value, expire } = data;\
      // æ— è¿‡æœŸæ—¶é—´æˆ–è€…æœªè¿‡æœŸè¿”å›ç¼“å­˜çš„å€¼\
      if (expire === 0 || expire > new Date().getTime()) {\
        return value;\
      }\
      // è¿‡æœŸåˆ™åˆ é™¤\
      remove(key);\
      return null;\
    } catch (e) {\
      return null;\
    }\
  }\
\
  function remove(key: string) {\
    storage.removeItem(getKey(key));\
  }\
\
  function clear() {\
    storage.clear();\
  }\
\
  return {\
    set,\
    get,\
    remove,\
    clear,\
  };\
}' > packages/@core/base/shared/src/utils/storage.ts

# é‡æ–°é“¾æ¥ä¾èµ–
RUN pnpm install --no-frozen-lockfile

# æ‰§è¡Œæ„å»º
RUN cd apps/web-ele && pnpm run build

RUN echo "Builder Success ğŸ‰"

FROM nginx:stable-alpine AS production

RUN echo "types { application/javascript js mjs; }" > /etc/nginx/conf.d/mjs.conf
COPY --from=builder /app/apps/web-ele/dist /usr/share/nginx/html

COPY --from=builder /app/scripts/deploy/nginx.conf /etc/nginx/nginx.conf

HEALTHCHECK --interval=30s --timeout=10s --retries=3 CMD wget -q -O /dev/null http://localhost:8080/health || exit 1

EXPOSE 8080

# start nginx
CMD ["nginx", "-g", "daemon off;"]
